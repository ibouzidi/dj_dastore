{% extends "../sub_base.html" %}
{% load static %}
{% load i18n %}
{% load two_factor_tags %}

{% block sub_content %}
    <style>
        .user-avatar {
            border: 1px solid var(--clr-violet-1);
        }
    </style>
    <div class="row gutters-sm">
        <div class="col-md-3 d-none d-md-block">
            <div class="card">
                <div class="card-body">
                    {% include 'account/profile_tab.html' %}
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header border-bottom mb-3 d-flex d-md-none">
                    {% include 'account/profile_tab_mobile.html' %}
                </div>
                <div class="card-body tab-content">
                    <div class="tab-pane active" id="profile">
                        <h6>YOUR PROFILE INFORMATION</h6>
                        <hr>
                        <div class="row">
                            <div class="col-lg-4 col-md-12 mb-4">
                                <div class="card border-light text-center p-0">
                                    <div class="profile-cover rounded-top"
                                         data-background="/static/assets/img/profile-cover.jpg">
                                    </div>
                                    <div class="card-body pb-5">
                                        {% if user.avatar_url and 'default_user_icon.png' not in user.avatar_url %}
                                            <img src="{{ user.avatar_url }}" class="user-avatar border-2 border-purple large-avatar rounded-circle mx-auto mt-n7 mb-4" alt="Neil Portrait">
                                        {% else %}
                                            <img src="{% static 'dastore/default_user_icon.png' %}" class="border-2 border-purple user-avatar large-avatar rounded-circle mx-auto mt-n7 mb-4">
                                        {% endif %}
                                        <h5 class="h4">{{ username }}</h5>
                                        <p class="prm-btn btn purple">Subscription Plan : {{ subscription_plan }}</p>
                                    </div>
                                </div>
                            <hr>
                                <div class="col-12 mb-4">
                            <div class="card card-body bg-white border-light shadow-sm mb-4">
                                <h2 class="h5 mb-4">Storage information</h2>
                                <!-- Create a canvas element to display the chart -->
                                <canvas id="storageUsageChart"></canvas>
                            </div>
                        </div>
                            </div>
                            <div class="col-lg-8 col-md-12">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <h6 class="mb-0">Full Name</h6>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="text-muted mb-0">{{ first_name}}  {{ last_name }}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <h6 class="mb-0">Username</h6>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="text-muted mb-0">{{ username }}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <h6 class="mb-0">Email</h6>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="text-muted mb-0">{{ email }}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <h6 class="mb-0">Phone</h6>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="text-muted mb-0">{{ phone }}</p>
                                    </div>
                                </div>
                                <hr>
                                <h2 class="h5 my-4">Address</h2>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <h6 class="mb-0">City</h6>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="text-muted mb-0">{{ city }}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <h6 class="mb-0">Address</h6>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="text-muted mb-0">{{ address }}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <h6 class="mb-0">Number</h6>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="text-muted mb-0">{{ number }}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <h6 class="mb-0">Zip</h6>
                                    </div>
                                    <div class="col-sm-6">
                                        <p class="text-muted mb-0">{{ zip }}</p>
                                    </div>
                                </div>

                            </div>
                            <div class="mt-3">
                                {% if is_self %}
                                    <a href="{% url 'account:account_edit' user_id=id %}" class="prm-btn btn purple">Edit Profile</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="account">
                        <h6>ACCOUNT SETTINGS</h6>
                        <hr>
                        <form>
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input type="text" class="form-control" id="username" aria-describedby="usernameHelp" placeholder="Enter your username" value="kennethvaldez">
                                <small id="usernameHelp" class="form-text text-muted">After changing your username, your old username becomes available for anyone else to claim.</small>
                            </div>
                            <hr>
                            <div class="form-group">
                                <label class="d-block text-danger">Delete Account</label>
                                <p class="text-muted font-size-sm">Once you delete your account, there is no going back. Please be certain.</p>
                            </div>
                            <button class="btn btn-danger" type="button">Delete Account</button>
                        </form>
                    </div>
                    <div class="tab-pane" id="security">
                        <h6>SECURITY SETTINGS</h6>
                        <hr>
                        {% include 'account/password_change.html' %}
                        <hr>
                        <form>
                            <div class="form-group">
                                <label class="d-block">Two Factor Authentication</label>
                                {% if default_device %}
                                    <h6>{% blocktrans trimmed %}Congratulations, you've successfully enabled two-factor
                                        authentication.{% endblocktrans %}</h6>
                                    <p>{% blocktrans trimmed %}However we strongly discourage you to do so, you can
                                        also disable two-factor authentication for your account.{% endblocktrans %}</p>
                                    <div class="mt-3">
                                        <p><a class="btn btn-secondary" href="{% url 'two_factor:disable' %}">

                                            {% trans "Disable Two-Factor Authentication" %}</a>
                                            <a href="{% url 'two_factor:profile' %}"
                                               class="btn btn btn-link">{% trans "Back to Account Security" %}</a></p>
                                    </div>
                                {% else %}
                                    <p>{% blocktrans trimmed %}Two-factor authentication is not enabled for your
                                        account. Enable two-factor authentication for enhanced account
                                        security.{% endblocktrans %}</p>
                                    <p><a href="{% url 'two_factor:setup' %}" class="sec-btn btn purple-two">
                                        {% trans "Enable Two-Factor Authentication" %}</a>
                                    </p>
                                {% endif %}
                                <p class="small text-muted mt-2">Two-factor authentication adds an additional layer of security to your account by requiring more than just a password to log in.</p>
                            </div>
                        </form>
                        <hr>
                        <form>
                            <div class="form-group mb-0">
                                <label class="d-block">Sessions</label>
                                <p class="font-size-sm text-secondary">This is a list of devices that have logged into your account. Revoke any sessions that you do not recognize.</p>
                                <ul class="list-group list-group-sm">
                                    <li class="list-group-item has-icon">
                                        <div>
                                            <h6 class="mb-0">San Francisco City 190.24.335.55</h6>
                                            <small class="text-muted">Your current session seen in United States</small>
                                        </div>
                                        <button class="btn btn-light btn-sm ml-auto" type="button">More info</button>
                                    </li>
                                </ul>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane" id="notification">
                        <h6>STORAGE INFORMATION</h6>
                        <hr>
                        <div class="col-12 mb-4">
                            <div class="card card-body bg-white border-light shadow-sm mb-4">
                                <h2 class="h5 mb-4">Storage information</h2>
                                <!-- Create a canvas element to display the chart -->
                                <canvas id="storageUsageChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script>

        {#$('.show-change-password').on('click', function() {#}
        {#    // Set the modal title#}
        {#    $("#confirmModalLabel").text("Reset Password");#}
        {#    $("#confirmButton").text("Update");#}
        {#    $("#dismissButton").text("Cancel");#}
        {#    $("#confirmModal").attr("data-keyboard", "true");#}
        {#    $("#confirmModal").attr("data-backdrop", "dynamic");#}
        {#    // Set the modal body with the form#}
        {#    $("#confirmMessage").html($("#passwordChangeDiv").html());#}
        {#    // Show the modal#}
        {#    $("#confirmModal").modal("show");#}
        {#});#}

            $("#show-change-password").on('click', function(e) {
                e.preventDefault();
                $.ajax({
                    type: 'POST',
                    url: "{% url 'account:password_change' %}",
                    data: $('#passwordChangeForm').serialize(),
                    dataType: 'json',
                    success: function(data) {
                        if (data.result === 'success') {
                            // Close the modal and display a success message
                            $('#confirmModal').modal('hide');
                            const notyf = new Notyf();
                            notyf.success("Password changed successfully.");
                            $("#passwordChangeForm")[0].reset();
                        }
                    },
                    error: function(data) {
                        // Display form errors in the modal
                        $.each(data.responseJSON, function(field, errors) {
                            var errorDiv = $(`#id_${field}`).closest('.form-group').find('.errors');
                            errorDiv.empty();
                            $.each(errors, function(index, error){
                                errorDiv.append(`<p style="color: red">${error}</p>`);
                            });
                        });
                    }
                });
            });
            {#    <!-- Add JavaScript to create the chart -->#}
            function getRandomColor() {
                let letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            let storageUsed = {{ storage_used }};
            let storageUsedUnit = "{{ storage_used_unit }}";
            let storageLimit = {{ storage_limit }};
            let storageLimitUnit = "{{ storage_limit_unit }}";

            if (storageUsedUnit == "GB") {
                storageUsed *= 1024;
            }
            let usedPercentage = Math.round((storageUsed / (storageLimit * 1024)) * 100);
            let availablePercentage = 100 - usedPercentage;

            {#console.log("storageUsed", storageUsed);#}
            {#console.log("storageUsedUnit", storageUsedUnit);#}
            {#console.log("storageLimit", storageLimit);#}
            {#console.log("storageLimitUnit", storageLimitUnit);#}
            {#console.log("usedPercentage", usedPercentage);#}
            {#console.log("availablePercentage", availablePercentage);#}

            let ctx = document.getElementById('storageUsageChart').getContext('2d');
            let storageUsageChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Used', 'Available'],
                    datasets: [{
                        data: [usedPercentage, availablePercentage],
                        backgroundColor: [getRandomColor(), getRandomColor()],
                    }]
                },
                options: {
                    title: {
                        display: true,
                        text: 'Storage Usage'
                    },
                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, data) {
                                let dataset = data.datasets[tooltipItem.datasetIndex];
                                let index = tooltipItem.index;

                                if (index == 0) {
                                    if (storageUsedUnit == "GB") {
                                        return 'Used: ' + (storageUsed / 1024).toFixed(2) + ' ' + storageUsedUnit;
                                    }
                                    else{
                                        return 'Used: ' + (storageUsed).toFixed(2) + ' ' + storageUsedUnit;
                                    }
                                } else {
                                    let avaiblable = (storageLimit * 1024 - storageUsed).toFixed(2)
                                    if (avaiblable < 1000){
                                        return 'Available: ' + (storageLimit * 1024 - storageUsed).toFixed(2) + ' ' + 'MB';
                                    }else{
                                        return 'Available: ' + (storageLimit - storageUsed /1024).toFixed(2) + ' ' + storageLimitUnit;

                                    }
                                }
                            }
                        }
                    }
                }
            });
    </script>

{% endblock %}



