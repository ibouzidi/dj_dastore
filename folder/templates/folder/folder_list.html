{% extends 'base.html' %}
{% block title %} Backup {% endblock title %}

{% block breadcrumb %}
    {% include "extbackup/exbackup_breadcrumb.html" %}
{% endblock %}

{% block content %}

    <!-- Menu Backup Action  -->
    <div class="d-flex justify-content-end action_btn">
        <button class="btn btn-outline-primary mx-2 pl-3 pr-3" title="Add Folder" id="addFolderButton">
            <i class="fas fa-folder-plus fa-lg d-block"></i>
        </button>
        <button class="btn btn-outline-primary mr-2 pl-3 pr-3" title="Upload" id="addFilesButton">
            <i class="fas fa-cloud-upload-alt fa-lg d-block"></i>
        </button>
        <button class="btn btn-outline-primary mr-2 pl-3 pr-3" title="Download">
            <i class="fas fa-cloud-download-alt fa-lg d-block"></i>
        </button>
    </div>

    <div class="delete_action">
        <div class="row">
            <div class="col-6 col-md-2 col-lg-2 mb-3">
                <input type="checkbox" id="select-all">
                <label for="select-all">Select All</label>

                <button id="delete-selected" class="btn btn-danger">Delete Selected</button>
            </div>
        </div>
    </div>

    <!-- Custom Folder List -->
    <div class="mt-3">
        <div class="row">
            {% if folder_list|length > 0 %}
                <p>Custom Folder</p>
            {% endif %}
            {% for folder in folder_list %}
                <div class="col-6 col-md-4 col-lg-2 mb-3">
                    <div class="card border-0 rounded-0 shadow position-relative">
                        <a href="{{ folder.get_list_url }}?id={{ folder.pk }}" class="text-decoration-none">
                            <input class="folder-checkbox form-check-input position-absolute" id="check_all" data-id="{{ folder.pk }}" type="checkbox" style="top: 10px; right: 10px;">

                            <div class="card-body text-center">

                                <i class="fas fa-folder fa-3x mb-3"></i>
                                <p class="card-title mb-0;">{{ folder.name }}</p>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-left position-absolute" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="#">Option 1</a>
                            <a class="dropdown-item" href="#">Option 2</a>
                            <a class="dropdown-item" href="#">Option 3</a>
                        </div>
                        <button class="btn btn-link dropdown-toggle position-absolute" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- File List -->
    <div class="mt-3">
        <div class="row">
            {% if file_list|length > 0 %}
                <p>Your Backup</p>
            {% endif %}
            {% for file in  file_list %}
                <div class="col-6 col-md-4 col-lg-2 mb-3">
                    <div class="card border-0 rounded-0 shadow position-relative">
                        <a href="{% url 'extbackup:view_zip_content' file.0  %}" class="text-decoration-none">
                            <input class="file-checkbox form-check-input position-absolute" id="check_all" data-id="{{ file.0 }}" type="checkbox" style="top: 10px; right: 10px;">
                            <div class="card-body text-center">
                                <div class="icon-container">
                                    <i class="fas fa-folder fa-3x mb-3"></i>

                                    <span class="font-weight-normal">
                                        <i id="hash-check-icon-{{ file.0 }}" class="fa fa-question-circle text-warning" data-toggle="tooltip" data-placement="top" title="Integrity check: pending" style="display: none"></i>
                                        {{file.1}}
                                        <i id="hash-check-spinner-{{ file.0 }}" class="fa fa-spinner fa-spin d-none"></i>
                                </span>
                                </div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-left position-absolute" aria-labelledby="dropdownMenuButton" id="menu-{{ file.0 }}">
                            <a class="dropdown-item" href="{% url 'extbackup:download_zip_file' file.0  %}"><span class="fas fa-download mr-2"></span>Download</a>
                            <a class="dropdown-item text-info check-hash" href="#"  data-file-id="{{ file.0 }}" data-url="{% url 'extbackup:check_file_hashes' file_id=file.0 %}">
                                <span class="material-symbols-outlined mr-2" style="line-height: 1;">plagiarism</span>Check Integrity
                            </a>
                            <a href="#" class="dropdown-item show-file-info" data-file-id="{{ file.0 }}">
                                <span class="fas fa-info-circle mr-2"></span>Show Info
                            </a>
                        </div>
                        <div id="detail-backup" class="d-none">
                            <div class="row">
                                <div class="col-4 font-weight-bold">Name:</div>
                                <div class="col-8"><span id="file-name-{{ file.1 }}">{{ file.1 }}</span></div>
                            </div>
                            <div class="row">
                                <div class="col-4 font-weight-bold">Description:</div>
                                <div class="col-8">
                                    <span id="file-description-{{ file.2 }}">
                                        {% if file.2|default_if_none:"" == "" %}
                                            No description for this Backup.
                                        {% else %}
                                            {{ file.2 }}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-4 font-weight-bold">Size:</div>
                                <div class="col-8"><span id="file-size-{{ file.4 }}">{{ file.4|sizify }}</span></div>
                            </div>
                        </div>

                        <button class="btn btn-link dropdown-toggle position-absolute" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Upload Form -->
    <div id="hiddenForm" class="upload_form d-none">
        <div class="row">
            <div class="col-12 col-xl-12">
                <div class="card card-body bg-white border-light shadow-sm mb-4">
                    <form enctype="multipart/form-data" method="post" action="" id="fileUploadForm">
                        {% csrf_token %}
                        <p>
                            {{ form_upload.folder.label_tag }} {{ form_upload.folder }}
                        </p>
                        <p>
                            {{ form_upload.description.label  }}
                            {{ form_upload.description }}
                        </p>
                        <p>
                            {{ form_upload.current_folder_id }}
                        </p>
                        <p>
                            <label for="myDragElement" class="dragAndUpload" data-post-string="">
                            <span class="dragAndUploadIcon">
                                <i class="dragAndUploadIconNeutral fas fa-arrow-up"></i>
                                <i class="dragAndUploadIconUploading fas fa-cog fa-spin"></i>
                                <i class="dragAndUploadIconFailure fas fa-times"></i>
                                <i class="dragAndUploadIconSuccess fas fa-check-circle"></i>
                            </span>
                                <span class="dragAndUploadIcon"></span><b class="dragAndUploadText"><span class="dragAndUploadTextLarge">Drag and drop</span> <span class="dragAndUploadTextSmall">or click to upload</span></b>
                                <i class="dragAndUploadCounter">0%</i>
                                {{ form_upload.file }}
                            </label>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Styling for the upload form */
        .dragAndUploadManual {
            display: none;
        }
        .dragAndUpload {
            color: rgb(100,100,100);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font: 0/1em "Helvetica Neue", "Segoe UI", sans-serif;
            font-weight: 400;
            height: 200px;
            line-height: 16px;
            position: relative;
            text-align: center;
            -moz-transition: all .2s;
            -webkit-transition: all .2s;
            transition: all .05s;
            width: 100%;
            border: 2px dashed gray;
            margin: 0;
            background-color: var(--clr-white-2);
            outline: 2px solid var(--clr-white-2);
            outline-offset: 5px;
        }
        .dragAndUploadText{
            font-size: 28px;
            font-weight: bold;
        }
        .dragAndUploadTextSmall{
            display: block;
            font-size: 20px;
            margin-top: 20px;
            font-weight: normal;
        }

        .dragAndUpload.dragAndUploadActive .dragAndUploadIcon .fas {
            transform: rotate(180deg);
        }
        .dragAndUpload.dragAndUploadActive{
            outline: 2px dashed var(--clr-white-2);
            outline-offset: -10px;
            background-color: var(--clr-white);
            -webkit-transition: outline-offset .15s ease-in-out, background-color .15s linear;
            transition: outline-offset .15s ease-in-out, background-color .15s linear;
        }

        .dragAndUpload:hover {
            border: 2px dashed #167bff;
        }

        .dragAndUploadIcon {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: #a5a5a5;
            margin-bottom: 10px;
        }

        .dragAndUploadIconNeutral {
            display: block;
        }

        .dragAndUploadIconUploading,
        .dragAndUploadIconSuccess,
        .dragAndUploadIconFailure {
            display: none;
        }

        .dragAndUploadCounter {
            display: none;
            font-size: 18px;
            font-weight: bold;
            color: #a5a5a5;
            margin-top: 5px;
        }

        /* Styling for the upload progress */
        .dragAndUploadUploading .dragAndUploadIconNeutral,
        .dragAndUploadUploading .dragAndUploadIconSuccess,
        .dragAndUploadUploading .dragAndUploadIconFailure {
            display: none;
        }

        .dragAndUploadUploading .dragAndUploadIconUploading {
            display: block;
        }

        .dragAndUploadUploading .dragAndUploadTextLarge {
            display: none;
        }

        .dragAndUploadUploading .dragAndUploadTextSmall {
            display: block;
        }

        /* Styling for the upload success */
        .dragAndUploadSuccess .dragAndUploadIconNeutral,
        .dragAndUploadSuccess .dragAndUploadIconUploading,
        .dragAndUploadSuccess .dragAndUploadIconFailure {
            display: none;
        }

        .dragAndUploadSuccess .dragAndUploadIconSuccess {
            display: block;
            color: green;
        }

        .dragAndUploadSuccess .dragAndUploadCounter {
            display: none;
            color: green;
        }

        .dragAndUploadSuccess .dragAndUploadTextSmall {
            display: block;
        }

        .dragAndUploadManual {
            display: none;
        }
        /* Styling for the upload failure */
        .dragAndUploadFailure .dragAndUploadIconNeutral,
        .dragAndUploadFailure .dragAndUploadIconUploading,
        .dragAndUploadFailure .dragAndUploadIconSuccess {
            display: none;
            color: green;
        }

        .dragAndUploadFailure .dragAndUploadIconFailure {
            display: block;
            color: red;
        }

        .dragAndUploadFailure .dragAndUploadCounter {
            display: none;
            color: red;
        }

        .dragAndUploadFailure .dragAndUploadTextSmall {
            display: block;
        }
        .dragAndUpload.dragAndUploadUploading .dragAndUploadCounter,
        .dragAndUpload.dragAndUploadSuccess .dragAndUploadCounter,
        .dragAndUpload.dragAndUploadFailure .dragAndUploadCounter {
            display: block;
        }
        .action_btn button:hover {
            transform: translateY(-5px);
            transition: transform 0.5s;
        }
    </style>

{% endblock %}
{% block script %}
    <script>
{#        $(document).ready(function() {#}
{#            // Select All functionality#}
{#            $('#select-all').click(function() {#}
{#                const isChecked = $(this).prop('checked');#}
{#                $('.folder-checkbox, .file-checkbox').prop('checked', isChecked);#}
{#            });#}
{##}
{#            // Delete Selected functionality#}
{#            $('#delete-selected').click(function() {#}
{#                var folderIds = $(".folder-checkbox:checked").map(function () {#}
{#                    return parseInt($(this).attr("data-id"));#}
{#                }).get();#}
{##}
{#                var fileIds = $(".file-checkbox:checked").map(function () {#}
{#                    return parseInt($(this).attr("data-id"));#}
{#                }).get();#}
{##}
{#                // Additional logic to get file IDs from selected custom folders#}
{#                $(".folder-checkbox:checked").each(function () {#}
{#                    var folderElement = $(this).closest(".card");#}
{#                    folderElement.find(".file-checkbox").each(function () {#}
{#                        fileIds.push(parseInt($(this).attr("data-id")));#}
{#                    });#}
{#                });#}
{#if (folderIds.length > 0 || fileIds.length > 0) {#}
{#                $.ajax({#}
{#                    type: 'POST',#}
{#                    url: '{% url 'extbackup:delete_backup_view' %}',#}
{#                    data: {#}
{#                        csrfmiddlewaretoken: '{{ csrf_token }}',#}
{#                        folder_ids: JSON.stringify(folderIds),#}
{#                        file_ids: JSON.stringify(fileIds)#}
{#                    },#}
{#                    success: function(response) {#}
{#                        if (response.status === 'success') {#}
{#                            location.reload();#}
{#                        } else {#}
{#                            alert('Error deleting selected items');#}
{#                        }#}
{#                    }#}
{#                });#}
{#            }#}
{#        });#}
{#        });#}

        const urlParams = new URLSearchParams(window.location.search);
        const parentFolderId = urlParams.get("id");

        /**
         * This code updates an icon's CSS class based on an AJAX response
         * and displays a tooltip with the response message.
         */
        $('.integrity-tooltip').tooltip();
        $('.check-hash').click(function(event) {
            event.preventDefault();
            const url = $(this).data('url');
            const file_id = $(this).data('file-id');
            console.log(file_id)
            const icon = $('#hash-check-icon-' + file_id);
            const spinner = $('#hash-check-spinner-' + file_id);

            // Show the icon
            icon.show();

            // Show the spinner
            spinner.removeClass('d-none');
            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(response, textStatus, xhr) {
                    const status = response.message;
                    const statusCode = xhr.status;
                    const icon = $('#hash-check-icon-' + file_id);
                    if (statusCode === 200) {
                        icon.removeClass('fa-question-circle text-warning').addClass(
                            'fa-check-circle text-success');
                    } else {
                        icon.removeClass('fa-question-circle text-warning').addClass(
                            'fa-exclamation-circle text-danger');
                    }
                    icon.tooltip('dispose').tooltip();
                    icon.attr('data-original-title', status).tooltip('show');
                    // Automatically hide the tooltip after 3 seconds (3000 ms)
                    setTimeout(function() {
                        icon.tooltip('hide');
                    }, 3000);
                },
                error: function(xhr, textStatus, errorThrown) {
                    const message = xhr.responseJSON.message;
                    const icon = $('#hash-check-icon-' + file_id);
                    icon.removeClass('fa-check-circle text-success').addClass(
                        'fa-exclamation-circle text-danger');

                    if (xhr.status === 429) {
                        // Display the rate limit message to the user
                        // You can use an alert, a tooltip, or any other preferred method
                        icon.tooltip('dispose').tooltip();
                        icon.attr('data-original-title', message).tooltip('show');
                    } else {
                        icon.tooltip('dispose').tooltip();
                        console.error('Error:', errorThrown);
                        icon.attr('data-original-title', message).tooltip('show');
                    }
                },
                complete: function() {
                    // Hide the spinner
                    spinner.addClass('d-none');
                }
            });
        });

        /**
         * Code for the upload process.
         */
        var isUploadComplete = false;
        var
            duConfig,
            skeleton = {
                // URL to post upload to.
                url: '{% url 'extbackup:upload_files' %}',
                // Max total size of uploads.
                maxSize: 536870912,
                // Max number of files to upload.
                maxFiles: 5,
                // Allowed MIME types. Set to [] to allow all file types.
                // Otherwise: ['image/png', 'text/html']
                allowedFileTypes: [],
                // Base target CSS class.
                staticClass: 'dragAndUpload',
                // Mouse over CSS class.
                hoverClass: 'dragAndUploadActive',
                // Currently uploading CSS class.
                uploadingClass: 'dragAndUploadUploading',
                // Error CSS class.
                errorClass: 'dragAndUploadFailure',
                // Successful upload CSS class.
                successClass: 'dragAndUploadSuccess',
                // Class of counter element.
                counterClass: 'dragAndUploadCounter',
                // Class of manual upload element.
                manualElement: 'dragAndUploadManual',

                /**
                 * Checks if the event is a child of the drop element. If it is,
                 * it returns the parent element -- i.e. the one handling the dropped
                 * files. This is the element where we set one of the aforementioned
                 * CSS classes.
                 * @t: HTML element.
                 */
                setElement: function ( t ) {
                    if ( t ) {
                        return ( t.nodeName === 'label' ? t : t.closest( 'label' ) );
                    }
                },

                /**
                 * Removes a CSS class from the received HTML element.
                 * @t: HTML element.
                 * @className: CSS class to remove.
                 */
                removeClass: function ( t, className ) {
                    if ( t.className.indexOf( className ) > -1 ) {
                        className = ' ' + className;
                        var tempClass = t.className.replace( className, '' );
                        t.className = tempClass;
                    }
                },

                /**
                 * Changes the CSS class of the drop element, and updates
                 * the text of the status element.
                 * @text: Status text.
                 * @isError: 0 = Not an error message. 1 = Is an error message.
                 * @dropElement: Drop element.
                 * @response: HTTP response.
                 * @s: This class, passed in because of JS's object odditites.
                 */
                message: function ( text, isError, dropElement, response, s ) {
                    console.log( "message function" );
                    console.log( response );
                    var changeToClass = isError === 1 ? this.errorClass : this.successClass,
                        uploadingClass = this.uploadingClass,
                        counterElement = dropElement.querySelector( '.' + s.counterClass );
                    this.removeClass( dropElement, uploadingClass );
                    dropElement.className += ' ' + changeToClass;
                    counterElement.innerHTML = text;
                },


                /**
                 * Checks that files are valid for upload.
                 * @files: Files dropped onto element.
                 * @s: This class, passed in because of JS's object odditites.
                 * @dropElement: Drop element.
                 */
                validFiles: function ( files, s, dropElement ) {
                    $('.dragAndUploadText').hide();
                    $('.dragAndUploadTextSmall').hide();
                    var data = new FormData();
                    var filesTotalSize = 0,
                        totalFiles = files.length,
                        filePlural = totalFiles > 0 ? "files" : "file",
                        allFilesAllowed = true;
                    for ( var i = 0; i < files.length; i++ ) {
                        if ( s.allowedFileTypes.indexOf( files[i].type ) === -1 && s.allowedFileTypes.length > 0 ) {
                            allFilesAllowed = false;
                            break;
                        } else {
                            data.append( 'file', files[i] );
                            var fileDescription = $('#file-description').val();
                            if (fileDescription.trim() !== '') {
                                data.append('description', fileDescription.trim());
                            }
                            if (parentFolderId.trim() !== '') {
                                data.append('parent_folder_id', parentFolderId.trim());
                            }
                            filesTotalSize += files[i].size;
                        }
                    }
                    data.append("csrfmiddlewaretoken", "{{ csrf_token }}");
                    if ( allFilesAllowed === false ) {
                        s.message( 'File types not allow.', 1, dropElement, '', s );
                        return 'failed';
                    } else if ( filesTotalSize > s.maxSize ) {
                        s.message( 'Total size of ' + filePlural + ' too big.', 1, dropElement, '', s );
                        return 'failed';
                    } else if ( totalFiles > s.maxFiles ) {
                        s.message( 'Only ' + s.maxFiles + ' ' + filePlural + ' allowed.', 1, dropElement, '', s );
                        return 'failed';
                    } else {
                        return data;
                    }
                },

                /**
                 * Where the actual HTTP upload happens.
                 * @dropElement: Drop element.
                 * @s: This class, passed in because of JS's object odditites.
                 * @data: Form data.
                 */
                uploadFiles: function ( dropElement, s, data ) {
                    $('.dragAndUploadIconUploading').show();
                    // show uploading icon
                    var xhr = new XMLHttpRequest(),
                        counterElement = dropElement.querySelector( '.' + s.counterClass );
                    dropElement.removeAttribute( 'data-response' );

                    xhr.onreadystatechange = function ( e ) {
                        if ( xhr.readyState === 4 ) {
                            var response = JSON.parse( xhr.responseText );
                            if ( xhr.status === 200 ) {
                                isUploadComplete = true
                                s.message( response.message + ' <a href="' + window.location.href + '">Click here to upload again</a>.', 0, dropElement, xhr.responseText, s );
                                dropElement.setAttribute( 'data-response', xhr.responseText );
                                dropElement.querySelector('input[type="file"]').setAttribute('disabled', 'disabled');
                                $(".dragAndUpload ").css("cursor", "default");
                                $(".dragAndUploadTextSmall a").css("cursor", "pointer");
                            } else if ( xhr.status === 400 ) {
                                s.message( response.message + ' <a href="' + window.location.href + '">Click here to upload again</a>.', 1, dropElement, xhr.responseText, s );
                                dropElement.querySelector('input[type="file"]').setAttribute('disabled', 'disabled');
                                $(".dragAndUpload ").css("cursor", "default");
                                $(".dragAndUploadTextSmall a").css("cursor", "pointer");
                            } else {
                                s.message( 'Upload failed with status ' + xhr.status + '.', 1, dropElement, xhr.responseText, s );
                            }
                        }
                    };
                    xhr.upload.onprogress = function ( e ) {
                        var percent = ( parseInt( ( e.loaded / e.total ) * 100 ) );
                        if ( isNaN( percent ) ) { percent = 0; }
                        counterElement.innerHTML = percent + '%';
                        if ( percent === 100 ) {
                            counterElement.innerHTML = 'Working&#8230;';
                        }
                    };
                    xhr.open( 'POST', s.url);
                    {#xhr.setRequestHeader('Content-Type', 'application/json');#}
                    {#xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));#}
                    xhr.send( data );
                },

                /**
                 * Start the upload.
                 * @files: Files dropped onto element.
                 * @s: This class, passed in because of JS's object odditites.
                 * @dropElement: Files dropped onto element.
                 */
                uploadSetup: function ( files, s, dropElement ) {
                    var data = this.validFiles( files, s, dropElement );
                    console.log("data")
                    console.log(data)
                    if ( data !== 'failed' ) {
                        this.uploadFiles( dropElement, s, data );
                    }
                },
            },

            dragAndUpload = {
                /**
                 * Handles manually uploaded files.
                 * @event: HTML element event.
                 */
                handleManualUpload: function ( event ) {
                    event.stopPropagation();
                    event.preventDefault();
                    var s = duConfig,
                        t = event.target,
                        files = t.files,
                        findId = t.getAttribute( 'id' ),
                        dropElement = document.querySelector( '[for="' + findId + '"]' );
                    s.removeClass( dropElement, s.successClass );
                    s.removeClass( dropElement, s.errorClass );
                    dropElement.className += ' ' + s.uploadingClass;
                    s.uploadSetup( files, s, dropElement );
                },

                /**
                 * Handles dropped files.
                 * @event: HTML element event.
                 */
                handleDrop: function ( event ) {
                    event.stopPropagation();
                    event.preventDefault();
                    // Check if upload is complete
                    if (isUploadComplete) {
                        return;
                    }
                    var s = duConfig,
                        t = event.target,
                        files = event.dataTransfer.files,
                        dropElement = skeleton.setElement( t );
                    s.removeClass( dropElement, s.successClass );
                    s.removeClass( dropElement, s.hoverClass );
                    dropElement.className += ' ' + s.uploadingClass;
                    s.uploadSetup( files, s, dropElement );
                },

                /**
                 * Handles drag over and leave.
                 * @event: HTML element event.
                 */
                handleDrag: function ( event ) {
                    event.stopPropagation();
                    event.preventDefault();
                    // Check if upload is complete
                    if (isUploadComplete) {
                        return;
                    }
                    var s = duConfig,
                        dropElement = s.setElement( event.target );
                    s.removeClass( dropElement, s.successClass );
                    s.removeClass( dropElement, s.errorClass );
                    if ( dropElement.className.indexOf( s.hoverClass ) === -1 ) {
                        dropElement.className += ' ' + s.hoverClass;
                    }
                },

                handleDragLeave: function ( event ) {
                    event.stopPropagation();
                    event.preventDefault();
                    // Check if upload is complete
                    if (isUploadComplete) {
                        return;
                    }
                    var s = duConfig,
                        dropElement = s.setElement( event.target );
                    s.removeClass( dropElement, s.successClass );
                    s.removeClass( dropElement, s.errorClass );
                    s.removeClass( dropElement, s.hoverClass );
                },

                /**
                 * Kick off.
                 */
                setUp: function ( config ) {
                    duConfig = Object.create( skeleton );
                    for ( var c in config ) {
                        duConfig[c] = config[c];
                    }
                    var dropZones = document.getElementsByClassName( duConfig.staticClass );
                    if ( dropZones.length > 0 ) {
                        for ( var i = 0; i < dropZones.length; i++ ) {
                            if ( window.FormData ) {
                                var manualElement = dropZones[i].querySelector( '.' + duConfig.manualElement );
                                manualElement.addEventListener( 'change', this.handleManualUpload, false );
                                dropZones[i].addEventListener( 'dragover', this.handleDrag, false );
                                dropZones[i].addEventListener( 'dragleave', this.handleDragLeave, false );
                                dropZones[i].addEventListener( 'drop', this.handleDrop, false );
                            } else {
                                dropZones[i].className += ' ' + duConfig.errorClass;
                                dropZones[i].querySelector( '.' + duConfig.messageElement ).innerHTML = 'Sorry, browser in incompatible.';
                            }
                        }
                    }
                }
            };

        /**
         * This code allow to files based on the current folder
         * using a modal window.
         */
        $("#addFilesButton").on("click", function() {
            // Set the modal title and message
            $("#confirmModalLabel").text("Backup Your Files");
            $("#confirmButton").text("Send").hide();
            $("#dismissButton").text("Discard");
            $("#confirmMessage").html($("#hiddenForm").html());
            // Kick-off
            // Re-initialize the event listeners for the form elements
            try {
                var d = Object.create(dragAndUpload);
                d.setUp();
            } catch (exception) {
                console.log('Error creating menus. ' +
                    'In all likelihood your browser is out ' +
                    'of date.\r\n', exception, '\r\n', navigator.userAgent);
            }
            // Show the modal
            $("#confirmModal").modal("show");
        });

        /**
         * This code allow to add folder based on the current folder
         * using a modal window.
         */
        $("#addFolderButton").on("click", function() {
            // Set the modal title and message
            $("#confirmModalLabel").text("Create New Folder");
            $("#confirmButton").text("Save");
            $("#dismissButton").text("Discard");
            $("#confirmMessage").html(
                `{{form_folder.name }}{{form_folder.parent_folder_id }}`);

            // Show the modal
            $("#confirmModal").modal("show");

            $("#confirmForm").on("submit", function(event) {
                event.preventDefault();

                // Get the folder name
                const folderName = $("#folderName").val();
                // Create form data for the POST request
                const formData = new FormData();
                formData.append("name", folderName);
                formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");
                //  and parent folder ID from the URL query parameter
                if (parentFolderId) {
                    formData.append("parent_folder_id", parentFolderId);
                }

                // Set the POST URL
                const postUrl = "{% url 'folder:folder_create' %}";

                // Send the POST request
                $.ajax({
                    url: postUrl,
                    method: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function() {
                        // Reload the page on successful folder creation
                        window.location.reload();
                    },
                    error: function() {
                        // Handle errors
                        console.error("Failed to create a new folder.");
                    }
                });

                // Close the modal
                $("#confirmModal").modal("hide");
            });
        });

        /**
         * This code allow to show a modal window containing information
         * about folder such as the name, description and size.
         */
        $('.show-file-info').on('click', function() {
            var detailBackup = $(this).closest('.card').find('#detail-backup');
            $('#confirmModalLabel').text('Detail Information');
            $('#confirmButton').hide();
            $('#dismissButton').text('Close');
            $('#confirmMessage').html(detailBackup.html());
            $('#confirmModal').modal('show');
        });

    </script>
{% endblock %}