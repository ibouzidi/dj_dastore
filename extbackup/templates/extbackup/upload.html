{% extends 'base.html' %}
{#{% load widget_tweaks %}#}
{% block title %} Home {% endblock title %}

{% block breadcrumb %}
    {% include "extbackup/exbackup_breadcrumb.html" %}
{% endblock %}

{% block content %}
    <style>
        /* Styling for the upload form */

        .dragAndUploadManual {
            display: none;
        }
        .dragAndUpload {
            color: rgb(100,100,100);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font: 0/1em "Helvetica Neue", "Segoe UI", sans-serif;
            font-weight: 400;
            height: 200px;
            line-height: 16px;
            position: relative;
            text-align: center;
            -moz-transition: all .2s;
            -webkit-transition: all .2s;
            transition: all .05s;
            width: 100%;
            border: 2px dashed gray;
            margin: 0;
            background-color: var(--clr-white-2);
            outline: 2px solid var(--clr-white-2);
            outline-offset: 5px;
        }
        .dragAndUploadText{
            font-size: 28px;
            font-weight: bold;
        }
        .dragAndUploadTextSmall{
            display: block;
            font-size: 20px;
            margin-top: 20px;
            font-weight: normal;
        }

        .dragAndUpload.dragAndUploadActive .dragAndUploadIcon .fas {
            transform: rotate(180deg);
        }
        .dragAndUpload.dragAndUploadActive{
            outline: 2px dashed var(--clr-white-2);
            outline-offset: -10px;
            background-color: var(--clr-white);
            -webkit-transition: outline-offset .15s ease-in-out, background-color .15s linear;
            transition: outline-offset .15s ease-in-out, background-color .15s linear;
        }

        .dragAndUpload:hover {
            border: 2px dashed #167bff;
        }

        .dragAndUploadIcon {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: #a5a5a5;
            margin-bottom: 10px;
        }

        .dragAndUploadIconNeutral {
            display: block;
        }

        .dragAndUploadIconUploading,
        .dragAndUploadIconSuccess,
        .dragAndUploadIconFailure {
            display: none;
        }

        .dragAndUploadCounter {
            display: none;
            font-size: 18px;
            font-weight: bold;
            color: #a5a5a5;
            margin-top: 5px;
        }

        /* Styling for the upload progress */
        .dragAndUploadUploading .dragAndUploadIconNeutral,
        .dragAndUploadUploading .dragAndUploadIconSuccess,
        .dragAndUploadUploading .dragAndUploadIconFailure {
            display: none;
        }

        .dragAndUploadUploading .dragAndUploadIconUploading {
            display: block;
        }

        .dragAndUploadUploading .dragAndUploadTextLarge {
            display: none;
        }

        .dragAndUploadUploading .dragAndUploadTextSmall {
            display: block;
        }

        /* Styling for the upload success */
        .dragAndUploadSuccess .dragAndUploadIconNeutral,
        .dragAndUploadSuccess .dragAndUploadIconUploading,
        .dragAndUploadSuccess .dragAndUploadIconFailure {
            display: none;
        }

        .dragAndUploadSuccess .dragAndUploadIconSuccess {
            display: block;
            color: green;
        }

        .dragAndUploadSuccess .dragAndUploadCounter {
            display: none;
            color: green;
        }

        .dragAndUploadSuccess .dragAndUploadTextSmall {
            display: block;
        }

        .dragAndUploadManual {
            display: none;
        }
        /* Styling for the upload failure */
        .dragAndUploadFailure .dragAndUploadIconNeutral,
        .dragAndUploadFailure .dragAndUploadIconUploading,
        .dragAndUploadFailure .dragAndUploadIconSuccess {
            display: none;
            color: green;
        }

        .dragAndUploadFailure .dragAndUploadIconFailure {
            display: block;
            color: red;
        }

        .dragAndUploadFailure .dragAndUploadCounter {
            display: none;
            color: red;
        }

        .dragAndUploadFailure .dragAndUploadTextSmall {
            display: block;
        }
        .dragAndUpload.dragAndUploadUploading .dragAndUploadCounter,
        .dragAndUpload.dragAndUploadSuccess .dragAndUploadCounter,
        .dragAndUpload.dragAndUploadFailure .dragAndUploadCounter {
            display: block;
        }
    </style>
    <div class="upload_view">
        <div class="row">
            <div class="col-12 col-xl-12">
                <div class="card card-body bg-white border-light shadow-sm mb-4">
                    <h2 class="h5 mb-4">Backup your Files</h2>
                    <form enctype="multipart/form-data" method="post" action="">
                        {% csrf_token %}
                        <p>
                            <label for="myDragElement" class="dragAndUpload" data-post-string="">
                                        <span class="dragAndUploadIcon">
                                            <i class="dragAndUploadIconNeutral fas fa-arrow-up"></i>
                                            <i class="dragAndUploadIconUploading fas fa-cog fa-spin"></i>
                                            <i class="dragAndUploadIconFailure fas fa-times"></i>
                                            <i class="dragAndUploadIconSuccess fas fa-check-circle"></i>
{#                                            <i class="dragAndUploadIconFailure fas fa-thumbs-down"></i>#}
                                        </span>
                                <span class="dragAndUploadIcon"></span><b class="dragAndUploadText"><span class="dragAndUploadTextLarge">Drag and drop</span> <span class="dragAndUploadTextSmall">or click to upload</span></b>
                                <i class="dragAndUploadCounter">0%</i>

                                <input type="file" multiple="multiple" class="dragAndUploadManual" name="file" id="myDragElement" />
                            </label>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block script %}
    <script>

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var
            duConfig,
            skeleton = {
                // URL to post upload to.
                url: '{% url 'extbackup:upload_files' %}',
                // Max total size of uploads.
                maxSize: 536870912,
                // Max number of files to upload.
                maxFiles: 5,
                // Allowed MIME types. Set to [] to allow all file types. Otherwise: ['image/png', 'text/html']
                allowedFileTypes: {{ supported_extensions|safe }},
                // Base target CSS class.
                staticClass: 'dragAndUpload',
                // Mouse over CSS class.
                hoverClass: 'dragAndUploadActive',
                // Currently uploading CSS class.
                uploadingClass: 'dragAndUploadUploading',
                // Error CSS class.
                errorClass: 'dragAndUploadFailure',
                // Successful upload CSS class.
                successClass: 'dragAndUploadSuccess',
                // Class of counter element.
                counterClass: 'dragAndUploadCounter',
                // Class of manual upload element.
                manualElement: 'dragAndUploadManual',

                /**
                 * Checks if the event is a child of the drop element. If it is,
                 * it returns the parent element -- i.e. the one handling the dropped
                 * files. This is the element where we set one of the aforementioned
                 * CSS classes.
                 * @t: HTML element.
                 */
                setElement: function ( t ) {
                    if ( t ) {
                        return ( t.nodeName === 'label' ? t : t.closest( 'label' ) );
                    }
                },

                /**
                 * Removes a CSS class from the received HTML element.
                 * @t: HTML element.
                 * @className: CSS class to remove.
                 */
                removeClass: function ( t, className ) {
                    if ( t.className.indexOf( className ) > -1 ) {
                        className = ' ' + className;
                        var tempClass = t.className.replace( className, '' );
                        t.className = tempClass;
                    }
                },

                /**
                 * Changes the CSS class of the drop element, and updates
                 * the text of the status element.
                 * @text: Status text.
                 * @isError: 0 = Not an error message. 1 = Is an error message.
                 * @dropElement: Drop element.
                 * @response: HTTP response.
                 * @s: This class, passed in because of JS's object odditites.
                 */
                message: function ( text, isError, dropElement, response, s ) {
                    console.log( "message function" );
                    console.log( response );
                    var changeToClass = isError === 1 ? this.errorClass : this.successClass,
                        uploadingClass = this.uploadingClass,
                        counterElement = dropElement.querySelector( '.' + s.counterClass );
                    this.removeClass( dropElement, uploadingClass );
                    dropElement.className += ' ' + changeToClass;
                    counterElement.innerHTML = text;
                },


                /**
                 * Checks that files are valid for upload.
                 * @files: Files dropped onto element.
                 * @s: This class, passed in because of JS's object odditites.
                 * @dropElement: Drop element.
                 */
                validFiles: function ( files, s, dropElement ) {
                    $('.dragAndUploadText').hide();
                    $('.dragAndUploadTextSmall').hide();
                    var data = new FormData();
                    {#const csrf_token = getCookie('csrftoken');#}
                    var filesTotalSize = 0,
                        totalFiles = files.length,
                        filePlural = totalFiles > 0 ? "files" : "file",
                        allFilesAllowed = true;
                    for ( var i = 0; i < files.length; i++ ) {
                        if ( s.allowedFileTypes.indexOf( files[i].type ) === -1 && s.allowedFileTypes.length > 0 ) {
                            allFilesAllowed = false;
                            break;
                        } else {
                            data.append( 'file', files[i] );
                            filesTotalSize += files[i].size;
                        }
                    }
                    {#data.append('csrfmiddlewaretoken', csrf_token);#}
                    if ( allFilesAllowed === false ) {
                        s.message( 'File types not allow.', 1, dropElement, '', s );
                        return 'failed';
                        {#} else if ( filesTotalSize > s.maxSize ) {#}
                            {#    s.message( 'Total size of ' + filePlural + ' too big.', 1, dropElement, '', s );#}
                            {#    return 'failed';#}
                            {#} else if ( totalFiles > s.maxFiles ) {#}
                                {#    s.message( 'Only ' + s.maxFiles + ' ' + filePlural + ' allowed.', 1, dropElement, '', s );#}
                                {#    return 'failed';#}
                            } else {
                                return data;
                            }
                            },

                            /**
                             * Where the actual HTTP upload happens.
                             * @dropElement: Drop element.
                             * @s: This class, passed in because of JS's object odditites.
                             * @data: Form data.
                             */
                            uploadFiles: function ( dropElement, s, data ) {
                                $('.dragAndUploadIconUploading').show();
                                // show uploading icon
                                var xhr = new XMLHttpRequest(),
                                    counterElement = dropElement.querySelector( '.' + s.counterClass );
                                dropElement.removeAttribute( 'data-response' );

                                xhr.onreadystatechange = function ( e ) {
                                    if ( xhr.readyState === 4 ) {
                                        var response = JSON.parse( xhr.responseText );
                                        if ( xhr.status === 200 ) {
                                            s.message( response.message, 0, dropElement, xhr.responseText, s );
                                            dropElement.setAttribute( 'data-response', xhr.responseText );
                                        } else if ( xhr.status === 400 ) {

                                            s.message( response.message, 1, dropElement, xhr.responseText, s );
                                        } else {
                                            s.message( 'Upload failed with status ' + xhr.status + '.', 1, dropElement, xhr.responseText, s );
                                        }
                                    }
                                };
                                xhr.upload.onprogress = function ( e ) {
                                    var percent = ( parseInt( ( e.loaded / e.total ) * 100 ) );
                                    if ( isNaN( percent ) ) { percent = 0; }
                                    counterElement.innerHTML = percent + '%';
                                    if ( percent === 100 ) {
                                        counterElement.innerHTML = 'Working&#8230;';
                                    }
                                };
                                xhr.open( 'POST', s.url);
                                {#xhr.setRequestHeader('Content-Type', 'application/json');#}
                                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                                xhr.send( data );
                            },

                            /**
                             * Start the upload.
                             * @files: Files dropped onto element.
                             * @s: This class, passed in because of JS's object odditites.
                             * @dropElement: Files dropped onto element.
                             */
                            uploadSetup: function ( files, s, dropElement ) {
                                var data = this.validFiles( files, s, dropElement );
                                if ( data !== 'failed' ) {
                                    this.uploadFiles( dropElement, s, data );
                                }
                            },
                        },

                            dragAndUpload = {
                                /**
                                 * Handles manually uploaded files.
                                 * @event: HTML element event.
                                 */
                                handleManualUpload: function ( event ) {
                                    event.stopPropagation();
                                    event.preventDefault();
                                    var s = duConfig,
                                        t = event.target,
                                        files = t.files,
                                        findId = t.getAttribute( 'id' ),
                                        dropElement = document.querySelector( '[for="' + findId + '"]' );
                                    s.removeClass( dropElement, s.successClass );
                                    s.removeClass( dropElement, s.errorClass );
                                    dropElement.className += ' ' + s.uploadingClass;
                                    s.uploadSetup( files, s, dropElement );
                                },

                                /**
                                 * Handles dropped files.
                                 * @event: HTML element event.
                                 */
                                handleDrop: function ( event ) {
                                    event.stopPropagation();
                                    event.preventDefault();
                                    var s = duConfig,
                                        t = event.target,
                                        files = event.dataTransfer.files,
                                        dropElement = skeleton.setElement( t );
                                    s.removeClass( dropElement, s.successClass );
                                    s.removeClass( dropElement, s.hoverClass );
                                    dropElement.className += ' ' + s.uploadingClass;
                                    s.uploadSetup( files, s, dropElement );
                                },

                                /**
                                 * Handles drag over and leave.
                                 * @event: HTML element event.
                                 */
                                handleDrag: function ( event ) {
                                    event.stopPropagation();
                                    event.preventDefault();
                                    var s = duConfig,
                                        dropElement = s.setElement( event.target );
                                    s.removeClass( dropElement, s.successClass );
                                    s.removeClass( dropElement, s.errorClass );
                                    if ( dropElement.className.indexOf( s.hoverClass ) === -1 ) {
                                        dropElement.className += ' ' + s.hoverClass;
                                    }
                                },

                                handleDragLeave: function ( event ) {
                                    event.stopPropagation();
                                    event.preventDefault();
                                    var s = duConfig,
                                        dropElement = s.setElement( event.target );
                                    s.removeClass( dropElement, s.successClass );
                                    s.removeClass( dropElement, s.errorClass );
                                    s.removeClass( dropElement, s.hoverClass );
                                },

                                /**
                                 * Kick off.
                                 */
                                setUp: function ( config ) {
                                    duConfig = Object.create( skeleton );
                                    for ( var c in config ) {
                                        duConfig[c] = config[c];
                                    }
                                    var dropZones = document.getElementsByClassName( duConfig.staticClass );
                                    if ( dropZones.length > 0 ) {
                                        for ( var i = 0; i < dropZones.length; i++ ) {
                                            if ( window.FormData ) {
                                                var manualElement = dropZones[i].querySelector( '.' + duConfig.manualElement );
                                                manualElement.addEventListener( 'change', this.handleManualUpload, false );
                                                dropZones[i].addEventListener( 'dragover', this.handleDrag, false );
                                                dropZones[i].addEventListener( 'dragleave', this.handleDragLeave, false );
                                                dropZones[i].addEventListener( 'drop', this.handleDrop, false );
                                            } else {
                                                dropZones[i].className += ' ' + duConfig.errorClass;
                                                dropZones[i].querySelector( '.' + duConfig.messageElement ).innerHTML = 'Sorry, browser in incompatible.';
                                            }
                                        }
                                    }
                                }
                            };

                            // Kick-off

                            window.onload = function () {
                                try {
                                    var d = Object.create( dragAndUpload );
                                    d.setUp();
                                } catch ( exception ) {
                                    console.log( 'Error creating menus. In all likelihood your browser is out of date.\r\n', exception, '\r\n', navigator.userAgent );
                                }
                            };
    </script>
{% endblock script %}